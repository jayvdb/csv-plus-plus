#!/usr/bin/env ruby
# frozen_string_literal: true

require 'optparse'
require_relative '../lib/csv_plus_plus'

options = ::CSVPlusPlus::Options.new

option_parser =
  ::OptionParser.new do |parser|
    parser.on('-h', '--help', 'Show help information') do
      puts(parser)
      exit
    end

    ::SUPPORTED_CSVPP_FLAGS.each do |flag|
      parser.on(flag.short_flag, flag.long_flag, flag.description) do |v|
        flag.handler.call(options, v)
      end
    end
  end

option_parser.parse!

error_message = options.validate
unless error_message.nil?
  warn(error_message)
  puts(option_parser)
  exit(1)
end

begin
  ::CSVPlusPlus.apply_template_to_sheet!(::ARGF.read, ::ARGF.filename, options)
rescue ::CSVPlusPlus::Error => e
  if e.is_a?(::CSVPlusPlus::Language::SyntaxError)
    warn(options.verbose ? e.to_verbose_trace : e.to_trace)
  else
    warn(e.message)
  end

  exit(1)
end
